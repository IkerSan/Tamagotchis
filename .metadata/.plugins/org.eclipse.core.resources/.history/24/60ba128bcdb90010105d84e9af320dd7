package org.cuatrovientos.dam.psp.tamagotchis;

import java.util.Random;

public class Tamagotchi extends Thread {
	
    public enum EstadoTamagotchi {
        OCIOSO, COMIENDO, JUGANDO, LIMPIANDOSE, MUERTO
    }
    
    private final String nombre;
    private final Cuidador cuidador;
    private final Random random = new Random();
    private final long tiempoCreacion = System.currentTimeMillis();
    
    private EstadoTamagotchi estado = EstadoTamagotchi.OCIOSO;
    private int suciedad = 0;
    private boolean vivo = true;
    private Thread hiloSuciedad, hiloVida;
    
    public Tamagotchi(String nombre, Cuidador cuidador) {
        this.nombre = nombre;
        this.cuidador = cuidador;
    }
    
    public String getNombre() { return nombre; }
    public synchronized EstadoTamagotchi getEstado() { return estado; }
    public synchronized int getSuciedad() { return suciedad; }
    public synchronized boolean isVivo() { return vivo; }
    public synchronized boolean estaOcioso() { return estado == EstadoTamagotchi.OCIOSO && vivo; }
    
    @Override
    public void run() {
        hiloSuciedad = new Thread(() -> {
            while (isVivo()) {
                try {
                    Thread.sleep(20000);
                    synchronized (this) {
                        if (estado != EstadoTamagotchi.LIMPIANDOSE && estado != EstadoTamagotchi.MUERTO) {
                            suciedad++;
                            if (suciedad == 5) System.out.println(nombre + ": ¡Estoy muy sucio!");
                            else if (suciedad >= 10) {
                                System.out.println(nombre + " murió por suciedad");
                                morir();
                            }
                        }
                    }
                } catch (InterruptedException e) { break; }
            }
        });
        
        hiloVida = new Thread(() -> {
            while (isVivo()) {
                try {
                    Thread.sleep(1000);
                    if (System.currentTimeMillis() - tiempoCreacion >= 300000) {
                        System.out.println(nombre + ": ¡Mi tiempo terminó!");
                        morir();
                    }
                } catch (InterruptedException e) { break; }
            }
        });
        
        hiloSuciedad.start();
        hiloVida.start();
    }
    
    public synchronized boolean comer() {
        if (!estaOcioso()) return false;
        estado = EstadoTamagotchi.COMIENDO;
        System.out.println(nombre + " empieza a comer...");
        
        int tiempo = random.nextInt(6) + 3;
        new Thread(() -> {
            try {
                Thread.sleep(tiempo * 1000);
            } catch (InterruptedException e) {
                return;
            }
            synchronized (this) {
                if (vivo) {
                    System.out.println(nombre + " terminó de comer (" + tiempo + "s)");
                    estado = EstadoTamagotchi.OCIOSO;
                    notifyAll(); // Notificar que terminó
                }
            }
        }).start();
        
        // Esperar a que termine
        try {
            while (estado == EstadoTamagotchi.COMIENDO && vivo) {
                wait();
            }
        } catch (InterruptedException e) {}
        
        return true;
    }
    
    public synchronized boolean jugar() {
        if (!estaOcioso()) return false;
        estado = EstadoTamagotchi.JUGANDO;
        System.out.println(nombre + " empieza a jugar...");
        
        new Thread(() -> {
            while (getEstado() == EstadoTamagotchi.JUGANDO && isVivo()) {
                int num1 = random.nextInt(9) + 1;
                int num2 = random.nextInt(9) + 1;
                int resultado = num1 + num2;
                
                if (resultado < 10) {
                    System.out.println(nombre + ": ¿Cuánto es " + num1 + " + " + num2 + "?");
                    if (cuidador.responderPregunta(nombre, resultado)) {
                        synchronized (this) {
                            if (vivo) {
                                System.out.println(nombre + ": ¡Correcto! Terminé de jugar");
                                estado = EstadoTamagotchi.OCIOSO;
                                notifyAll(); // Notificar que terminó
                            }
                        }
                        break;
                    } else {
                        System.out.println(nombre + ": Incorrecto, sigo jugando...");
                    }
                }
                try { Thread.sleep(2000); } catch (InterruptedException e) { break; }
            }
        }).start();
        
        // Esperar a que termine
        try {
            while (estado == EstadoTamagotchi.JUGANDO && vivo) {
                wait();
            }
        } catch (InterruptedException e) {}
        
        return true;
    }
    
    public synchronized boolean limpiar() {
        if (!estaOcioso()) return false;
        estado = EstadoTamagotchi.LIMPIANDOSE;
        System.out.println(nombre + " se está limpiando...");
        
        new Thread(() -> {
            try {
                Thread.sleep(5000);
            } catch (InterruptedException e) {
                return;
            }
            synchronized (this) {
                if (vivo) {
                    suciedad = 0;
                    System.out.println(nombre + " está limpio!");
                    estado = EstadoTamagotchi.OCIOSO;
                    notifyAll(); // Notificar que terminó
                }
            }
        }).start();
        
        // Esperar a que termine
        try {
            while (estado == EstadoTamagotchi.LIMPIANDOSE && vivo) {
                wait();
            }
        } catch (InterruptedException e) {}
        
        return true;
    }
    
    public synchronized void morir() {
        if (!vivo) return;
        vivo = false;
        estado = EstadoTamagotchi.MUERTO;
        System.out.println(nombre + " ha muerto.");
        if (hiloSuciedad != null) hiloSuciedad.interrupt();
        if (hiloVida != null) hiloVida.interrupt();
    }
}
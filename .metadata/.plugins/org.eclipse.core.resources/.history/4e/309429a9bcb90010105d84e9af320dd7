package org.cuatrovientos.dam.psp.tamagotchis;

import java.util.Random;

public class Tamagotchi extends Thread {
	
	public enum EstadoTamagotchi {
	    OCIOSO,
	    COMIENDO,
	    JUGANDO,
	    LIMPIANDOSE,
	    MUERTO
	}
	
    private String id;
    private EstadoTamagotchi estado;
    private int suciedad;
    private boolean vivo;
    private long tiempoCreacion;
    private Cuidador cuidador;
    private Random random;
    
    public Tamagotchi(String id, Cuidador cuidador) {
        this.id = id;
        this.cuidador = cuidador;
        this.estado = EstadoTamagotchi.OCIOSO;
        this.suciedad = 0;
        this.vivo = true;
        this.tiempoCreacion = System.currentTimeMillis();
        this.random = new Random();
    }
    
    @Override
    public void run() {
        // Hilo para controlar la suciedad
        Thread hiloSuciedad = new Thread(() -> {
            while (vivo) {
                try {
                    Thread.sleep(20000); // 20 segundos
                    if (estado != EstadoTamagotchi.LIMPIANDOSE && estado != EstadoTamagotchi.MUERTO) {
                        suciedad++;
                        System.out.println(id + " - Suciedad: " + suciedad);
                        
                        if (suciedad == 5) {
                            System.out.println(id + " avisa: Estoy empezando a estar muy sucio!");
                        } else if (suciedad >= 10) {
                            System.out.println(id + " ha muerto por exceso de suciedad!");
                            morir();
                        }
                    }
                } catch (InterruptedException e) {
                    break;
                }
            }
        });
        
        // Hilo para controlar el tiempo de vida
        Thread hiloVida = new Thread(() -> {
            while (vivo) {
                try {
                    Thread.sleep(1000); // Revisar cada segundo
                    long tiempoVida = (System.currentTimeMillis() - tiempoCreacion) / 1000;
                    
                    if (tiempoVida >= 300) { // 5 minutos = 300 segundos
                        System.out.println(id + " avisa: Mi tiempo ha terminado!");
                        morir();
                    }
                } catch (InterruptedException e) {
                    break;
                }
            }
        });
        
        hiloSuciedad.start();
        hiloVida.start();
    }
    
    public synchronized boolean comer() {
        if (estado != EstadoTamagotchi.OCIOSO || !vivo) {
            return false;
        }
        
        estado = EstadoTamagotchi.COMIENDO;
        System.out.println(id + " comienza a comer...");
        
        // Tiempo de comida aleatorio entre 3-8 segundos
        int tiempoComida = random.nextInt(6) + 3;
        
        new Thread(() -> {
            try {
                Thread.sleep(tiempoComida * 1000L);
                synchronized (this) {
                    if (vivo) {
                        System.out.println(id + " ha terminado de comer. Tardo " + tiempoComida + " segundos");
                        estado = EstadoTamagotchi.OCIOSO;
                    }
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }).start();
        
        return true;
    }
    
    public synchronized boolean jugar() {
        if (estado != EstadoTamagotchi.OCIOSO || !vivo) {
            return false;
        }
        
        estado = EstadoTamagotchi.JUGANDO;
        System.out.println(id + " comienza a jugar...");
        
        new Thread(() -> {
            while (true) {
                synchronized (this) {
                    if (estado != EstadoTamagotchi.JUGANDO || !vivo) break;
                }
                
                int num1 = random.nextInt(9) + 1;
                int num2 = random.nextInt(9) + 1;
                int resultado = num1 + num2;
                
                if (resultado < 10) {
                    System.out.println(id + " pregunta: Cuanto es " + num1 + " + " + num2 + "?");
                    boolean respuestaCorrecta = cuidador.responderPregunta(id, resultado);
                    
                    if (respuestaCorrecta) {
                        synchronized (this) {
                            if (vivo) {
                                System.out.println(id + ": Â¡Respuesta correcta! Termino de jugar.");
                                estado = EstadoTamagotchi.OCIOSO;
                            }
                        }
                        break;
                    } else {
                        System.out.println(id + ": Respuesta incorrecta, sigo jugando...");
                    }
                }
                
                try {
                    Thread.sleep(2000); // Espera antes de nueva pregunta
                } catch (InterruptedException e) {
                    break;
                }
            }
        }).start();
        
        return true;
    }
    
    public synchronized boolean limpiar() {
        if (estado != EstadoTamagotchi.OCIOSO || !vivo) {
            return false;
        }
        
        estado = EstadoTamagotchi.LIMPIANDOSE;
        System.out.println(id + " comienza a limpiarse...");
        
        new Thread(() -> {
            try {
                Thread.sleep(5000); // 5 segundos para limpiarse
                synchronized (this) {
                    if (vivo) {
                        suciedad = 0;
                        System.out.println(id + " esta completamente limpio!");
                        estado = EstadoTamagotchi.OCIOSO;
                    }
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }).start();
        
        return true;
    }
    
    public synchronized void morir() {
        vivo = false;
        estado = EstadoTamagotchi.MUERTO;
        System.out.println(id + " ha muerto.");
    }
    
    // Getters
    public String getIdTamagotchi() { return id; }
    public EstadoTamagotchi getEstado() { return estado; }
    public int getSuciedad() { return suciedad; }
    public boolean isVivo() { return vivo; }
    
    public synchronized boolean puedeSerDestruido() {
        return estado == EstadoTamagotchi.OCIOSO && vivo;
    }
    
    public synchronized boolean estaOcioso() {
        return estado == EstadoTamagotchi.OCIOSO && vivo;
    }
}